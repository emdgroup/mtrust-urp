on:
  pull_request:
    branches:
      - dev
name: PR Dev
jobs:
  validate_pr:
    permissions:
      pull-requests: write
    uses: VeryGoodOpenSource/very_good_workflows/.github/workflows/semantic_pull_request.yml@v1

  test_version:
    needs: validate_pr
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: 📇 Configure git
        run: |
          git fetch --prune --unshallow
          git config --global user.name "GitHub Actions"
          git config --global user.email "gh-actions@emdgroup.com"
        shell: bash

      # Retrieve the new version
      - name: 🔂 Run standard-version
        uses: actions/github-script@v7
        with:
          script: |
            const {execSync} = require('child_process');
            execSync('npx standard-version --dry-run', {stdio: 'inherit'});

  build_and_version:
    name: 📦 Build and version
    runs-on: macos-latest
    needs: test_version

    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      # Prepare all packages
      - name: 🎯 Prepare Flutter
        uses: ./.github/actions/prepare-flutter
        with:
          directory: ./

      - name: 👨🏻‍⚖️ Check dependency licenses
        run: |
          dart run packages.dart check-licenses

      - name: 🔍 Analyze dart
        run: |
          dart run packages.dart analyze

      - name: 🧪 Run tests
        run: |
          dart run packages.dart test
